$schema: 'https://moonrepo.dev/schemas/project.json'

type: application
language: rust

fileGroups:
  posts:
    - "posts/*.md"

project:
  name: personal-blog-database
  description: "The server for the personal blog database."

tasks:
  build:
    command: 'cargo build --release --locked'
    outputs:
      - 'target/x86_64-unknown-linux-musl/release/database'

  compile:
    command: 'uv run compile.py @in(0)' 
    inputs:
      - '@files(posts)'
    outputs:
      - 'db.sqlite3'

  docker:
    command: 'docker buildx build --no-cache -t ghcr.io/incognito124/$projectName:$timestamp -f $projectRoot/Dockerfile .'
    deps:
      - compile
      - build

  docker-push:
    command: 'docker buildx build --push --no-cache -t ghcr.io/incognito124/$projectName:$timestamp -f $projectRoot/Dockerfile .'
    inputs:
      - Cargo.toml
      - Cargo.lock
      - compile.py
      - "posts/*.md"
      - pyproject.toml
      - uv.lock
    deps:
      - compile
      - build