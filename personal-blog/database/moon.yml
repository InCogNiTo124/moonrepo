$schema: 'https://moonrepo.dev/schemas/project.json'

type: application
language: rust

fileGroups:
  posts:
    - "posts/*.md"

project:
  name: personal-blog-database
  description: "The server for the personal blog database."

tasks:
  build:
    # NOTE: on the build node, this is built with glibc. In docker, it's built with musl.
    command: 'cargo build --release'
    outputs:
      - 'target/release/database'

  compile:
    command: 'uv run compile.py @files(posts)' 
    outputs:
      - 'db.sqlite3'

  docker:
    command: 'docker buildx build --no-cache -t ghcr.io/incognito124/$projectName:$timestamp -f $projectRoot/Dockerfile .'
    deps:
      - compile

  docker-push:
    command: 'docker buildx build --push --no-cache -t ghcr.io/incognito124/$projectName:$timestamp -f $projectRoot/Dockerfile .'
    inputs:
      - Cargo.toml
      - Cargo.lock
      - compile.py
      - "posts/*.md"
      - pyproject.toml
      - uv.lock
    deps:
      - compile