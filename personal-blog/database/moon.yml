$schema: 'https://moonrepo.dev/schemas/project.json'

type: application
language: rust
tags:
  - docker

fileGroups:
  posts:
    - "posts/*.md"

project:
  name: personal-blog-database
  description: "The server for the personal blog database."

tasks:
  build:
    command: 'cargo build --release --locked'
    outputs:
      - 'target/x86_64-unknown-linux-musl/release/database'

  compile:
    command: 'uv run compile.py @in(0)' 
    inputs:
      - '@files(posts)'
    outputs:
      - 'db.sqlite3'

  docker:
    deps:
      - compile
      - build

  docker-push:
    deps:
      - compile
      - build

  staging:
    script: |
      FRONTEND_LATEST_IMAGE=$(docker image ls --filter 'reference=ghcr.io/incognito124/personal-blog-frontend' --format "{{.Repository}}:{{.Tag}}" | sort -r | head -n 1)
      DB_LATEST_IMAGE=$(docker image ls --filter 'reference=ghcr.io/incognito124/personal-blog-database' --format "{{.Repository}}:{{.Tag}}" | sort -r | head -n 1)
      moon generate --force docker-compose-blog $projectSource -- --frontendDockerImage "$FRONTEND_LATEST_IMAGE" --dbDockerImage "$DB_LATEST_IMAGE"
      docker compose -f $projectSource/docker-compose.yaml up && docker compose -f $projectSource/docker-compose.yaml rm -fs
 