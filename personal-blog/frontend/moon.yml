# yaml-language-server: $schema=../../.moon/cache/schemas/project.json

# Inherit tasks from the `sveltekit` preset
# https://github.com/moonrepo/moon-configs
tags:
  - sveltekit
  - docker

layer: application

project:
  name: personal-blog-frontend
  description: "Terra Incognita, personal blog"

dependsOn:
  - personal-reusables

tasks:
  check:
    deps:
      - personal-reusables:build
  build:
    command: bun
    args:
      - "run"
      - "build"
    deps:
      - personal-reusables:build
    outputs:
      - "build/**"
    options:
      merge: replace

  staging:
    script: |
      FRONTEND_LATEST_IMAGE=$(docker image ls --filter 'reference=ghcr.io/incognito124/personal-blog-frontend' --format "{{.Repository}}:{{.Tag}}" | sort -r | head -n 1)
      DB_LATEST_IMAGE=$(docker image ls --filter 'reference=ghcr.io/incognito124/personal-blog-database' --format "{{.Repository}}:{{.Tag}}" | sort -r | head -n 1)
      moon generate --force docker-compose-blog $projectSource -- --frontendDockerImage "$FRONTEND_LATEST_IMAGE" --dbDockerImage "$DB_LATEST_IMAGE"
      docker compose -f $projectSource/docker-compose.yaml up && docker compose -f $projectSource/docker-compose.yaml rm -fs && rm $projectSource/docker-compose.yaml
    deps:
      - docker
      - personal-blog-database:docker
