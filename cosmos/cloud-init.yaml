#cloud-config
# this file is technically a Python string template that gets rendered as yaml
write_files:
  - path: /etc/environment
    content: |-
      KUBECONFIG=/etc/rancher/k3s/k3s.yaml

  # Configure k9s to show all namespaces by default
  - path: /root/.config/k9s/config.yaml
    content: |
      k9s:
        clusters:
          default:
            namespace:
              active: all

  # Configure Floating IP
  - path: /etc/netplan/60-floating-ip.yaml
    content: |
      network:
        version: 2
        ethernets:
          eth0:
            addresses:
              - {floating_ip}/32

  # Create Static PV/PVC for Traefik ACME storage to ensure it uses the persistent volume
  - path: /var/lib/rancher/k3s/server/manifests/traefik-storage.yaml
    content: |
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: traefik-acme-pv
        labels:
          type: local
      spec:
        storageClassName: manual
        capacity:
          storage: 100Mi
        accessModes:
          - ReadWriteOnce
        hostPath:
          path: /data/traefik
      ---
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: traefik-acme-pvc
        namespace: kube-system
      spec:
        storageClassName: manual
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 100Mi
  
  # Configure Traefik to use the persistent volume for ACME with proper permissions
  - path: /var/lib/rancher/k3s/server/manifests/traefik-config.yaml
    content: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChartConfig
      metadata:
        name: traefik
        namespace: kube-system
      spec:
        valuesContent: |-
          additionalArguments:
            - "--log.level=DEBUG"
            - "--accesslog=true"
          certificatesResolvers:
            letsencrypt:
              acme:
                email: "{email}"
                storage: "/data/acme.json"
                tlsChallenge: true
                caServer: "{ca_server}"
          persistence:
            enabled: true
            existingClaim: traefik-acme-pvc
            mountPath: /data/traefik
          ports:
            web:
              redirections:
                entryPoint:
                  to: websecure
                  scheme: https
                  permanent: true
            metrics:
              port: 9101
              exposedPort: 9101
              expose:
                default: true
          metrics:
            prometheus:
              entryPoint: metrics
              addEntryPointsLabels: true
              addRoutersLabels: true

  # Pre-seed Sealed Secrets Master Key
  - path: /var/lib/rancher/k3s/server/manifests/sealed-secrets-key.yaml
    content: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: sealed-secrets-key
        namespace: kube-system
        labels:
          sealedsecrets.bitnami.com/sealed-secrets-key: active
      type: kubernetes.io/tls
      stringData:
        tls.crt: |
{ss_public_cert}
        tls.key: |
{ss_private_key}

  # Install ArgoCD via HelmChart
  - path: /var/lib/rancher/k3s/server/manifests/argocd-helm.yaml
    content: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: argocd
        namespace: kube-system
      spec:
        repo: https://argoproj.github.io/argo-helm
        chart: argo-cd
        targetNamespace: argocd
        createNamespace: true
        # Wait for the chart to be ready
        valuesContent: |-
          configs:
            secret:
              annotations:
                sealedsecrets.bitnami.com/managed: "true"
            cm:
              timeout.reconciliation: "60s"
          server:
            extraArgs:
              - --insecure # Optional: if you want to handle TLS at Traefik level easily

  # Bootstrap ArgoCD Apps
  - path: /var/lib/rancher/k3s/server/manifests/argocd-apps.yaml
    content: |
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: root-app
        namespace: argocd
        finalizers:
        - resources-finalizer.argocd.argoproj.io
      spec:
        project: default
        source:
          repoURL: https://github.com/InCogNiTo124/moonrepo
          targetRevision: HEAD
          path: cosmos/argocd/apps
        destination:
          server: https://kubernetes.default.svc
          namespace: argocd
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
          syncOptions:
            - SkipDryRunOnMissingResource=true
      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: key-to-cosmos
        namespace: argocd
        labels:
          argocd.argoproj.io/secret-type: repository
      stringData:
        url: https://github.com/InCogNiTo124/moonrepo
        type: git
        password: {gh_pat}
        username: git

runcmd:
  # Robust volume mounting logic
  - |
    DEVICE="/dev/disk/by-id/scsi-0HC_Volume_{volume_id}"
    MOUNT_POINT="/data"
    
    echo "Waiting for device $DEVICE to appear..."
    while [ ! -b "$DEVICE" ]; do
      sleep 1
    done
    
    echo "Device $DEVICE found. Checking filesystem..."
    if ! blkid "$DEVICE"; then
      echo "No filesystem found on $DEVICE. Formatting as ext4..."
      mkfs.ext4 -F "$DEVICE"
    fi
    
    echo "Mounting $DEVICE to $MOUNT_POINT..."
    mkdir -p "$MOUNT_POINT"
    mount -o discard,defaults "$DEVICE" "$MOUNT_POINT"
    
    echo "Adding $DEVICE to /etc/fstab..."
    echo "$DEVICE $MOUNT_POINT ext4 discard,defaults 0 2" >> /etc/fstab
    
    # Apply Floating IP configuration
    netplan apply
  
  # Ensure subdirectories exist on the mounted volume
  - mkdir -p /data/traefik
  - touch /data/traefik/acme.json
  - chmod 600 /data/traefik/acme.json
  - chown 65532:65532 /data/traefik/acme.json
  - mkdir -p /data/k3s-storage
  - mkdir -p /data/prometheus
  - mkdir -p /data/grafana
  - mkdir -p /data/alertmanager
  # Explicitly set permissions (mkdir -p -m only affects NEW directories)
  - chmod 755 /data/traefik
  - chown -R 65532:65532 /data/traefik
  - chmod 755 /data/k3s-storage
  - chmod 777 /data/prometheus
  - chmod 777 /data/grafana
  - chmod 777 /data/alertmanager

  # Install k9s
  - wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz && tar -xzvf k9s_Linux_amd64.tar.gz && mv k9s /usr/local/bin/ && rm k9s_Linux_amd64.tar.gz
  
  # Install k3s (Only after volume is ready)
  - curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.34.4+k3s1 sh -s - server --default-local-storage-path /data/k3s-storage
